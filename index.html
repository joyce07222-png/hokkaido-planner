import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, addDoc, deleteDoc, query } from 'firebase/firestore';
import { Heart, CupSoda, ShoppingBag, Calculator, Plus, Trash2, Calendar, Coffee, Star } from 'lucide-react';

// --- Firebase Configuration ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'drink-tracker-2026';

const App = () => {
  const [user, setUser] = useState(null);
  const [records, setRecords] = useState([]);
  const [loading, setLoading] = useState(true);
  
  // Form State
  const [shopName, setShopName] = useState('');
  const [itemName, setItemName] = useState('');
  const [price, setPrice] = useState('');
  const [sweetness, setSweetness] = useState('微糖');
  const [temp, setTemp] = useState('微冰');
  const [topping, setTopping] = useState('無');
  const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth() + 1);

  // Constants
  const sweetnessOptions = ['半糖', '微糖', '微微糖', '無糖'];
  const tempOptions = ['正常冰', '微冰', '去冰', '溫'];
  const toppingOptions = ['珍珠', '椰果', '無'];
  const months = Array.from({ length: 12 }, (_, i) => i + 1);

  // --- Auth Logic ---
  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // --- Data Fetching ---
  useEffect(() => {
    if (!user) return;
    
    const q = collection(db, 'artifacts', appId, 'users', user.uid, 'drinks');
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setRecords(data);
      setLoading(false);
    }, (error) => {
      console.error("Firestore error:", error);
      setLoading(false);
    });
    
    return () => unsubscribe();
  }, [user]);

  // --- Statistics Calculation ---
  const stats = useMemo(() => {
    if (records.length === 0) return { count: 0, total: 0, avg: 0, favShop: '尚未記錄', favItem: '尚未記錄' };
    
    const count = records.length;
    const total = records.reduce((sum, r) => sum + (Number(r.price) || 0), 0);
    const avg = Math.round(total / count);
    
    // Find favorite shop
    const shopCounts = records.reduce((acc, r) => {
      acc[r.shopName] = (acc[r.shopName] || 0) + 1;
      return acc;
    }, {});
    const favShop = Object.entries(shopCounts).sort((a, b) => b[1] - a[1])[0][0];

    // Find favorite item
    const itemCounts = records.reduce((acc, r) => {
      acc[r.itemName] = (acc[r.itemName] || 0) + 1;
      return acc;
    }, {});
    const favItem = Object.entries(itemCounts).sort((a, b) => b[1] - a[1])[0][0];

    return { count, total, avg, favShop, favItem };
  }, [records]);

  // --- Actions ---
  const handleAddRecord = async (e) => {
    e.preventDefault();
    if (!shopName || !itemName || !price) return;

    try {
      await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'drinks'), {
        shopName,
        itemName,
        price: Number(price),
        sweetness,
        temp,
        topping,
        month: selectedMonth,
        createdAt: new Date().toISOString()
      });
      // Reset basic inputs
      setShopName('');
      setItemName('');
      setPrice('');
    } catch (err) {
      console.error("Error adding document: ", err);
    }
  };

  const deleteRecord = async (id) => {
    await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'drinks', id));
  };

  const filteredRecords = records.filter(r => r.month === selectedMonth);

  return (
    <div className="min-h-screen bg-[#FDFBF7] text-[#5D4E46] p-4 md:p-8 font-['Zen_Maru_Gothic',sans-serif]">
      {/* Google Font Import */}
      <style>
        {`@import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap');`}
      </style>

      <div className="max-w-4xl mx-auto space-y-6">
        
        {/* Header Section */}
        <header className="text-center mb-8">
          <h1 className="text-3xl font-bold text-[#8B735B] mb-2 flex items-center justify-center gap-2">
             2026 飲料統計表 <Heart className="fill-[#D4A373] text-[#D4A373]" size={24} />
          </h1>
          <p className="text-[#A68A64]">店名：記錄每天的幸福時刻??</p>
        </header>

        {/* Favorite Stats Bar */}
        <div className="flex flex-col md:flex-row justify-between items-center bg-white/60 backdrop-blur-sm rounded-2xl p-4 border border-[#E9E1D6] shadow-sm gap-4">
          <div className="flex items-center gap-2 text-left w-full md:w-auto">
            <Star className="text-[#D4A373]" size={18} />
            <span className="font-medium text-sm">?? 最愛的飲料店：</span>
            <span className="bg-[#F2E8CF] px-3 py-1 rounded-full text-xs font-bold">{stats.favShop}</span>
          </div>
          <div className="flex items-center gap-2 text-right w-full md:w-auto justify-end">
            <span className="font-medium text-sm text-right">?? 最愛品項：</span>
            <span className="bg-[#F2E8CF] px-3 py-1 rounded-full text-xs font-bold">{stats.favItem}</span>
            <Coffee className="text-[#D4A373]" size={18} />
          </div>
        </div>

        {/* Annual Stats Summary */}
        <div className="grid grid-cols-3 gap-4">
          <div className="bg-[#FEFAE0] p-4 rounded-2xl border border-[#E9E1D6] text-center shadow-sm">
            <p className="text-xs text-[#A68A64] mb-1">年度杯數</p>
            <p className="text-xl font-bold text-[#8B735B]">{stats.count} <span className="text-xs">杯</span></p>
          </div>
          <div className="bg-[#FAEDCD] p-4 rounded-2xl border border-[#E9E1D6] text-center shadow-sm">
            <p className="text-xs text-[#A68A64] mb-1">年度總支出</p>
            <p className="text-xl font-bold text-[#8B735B]"><span className="text-xs">$</span> {stats.total}</p>
          </div>
          <div className="bg-[#FEFAE0] p-4 rounded-2xl border border-[#E9E1D6] text-center shadow-sm">
            <p className="text-xs text-[#A68A64] mb-1">平均單價</p>
            <p className="text-xl font-bold text-[#8B735B]"><span className="text-xs">$</span> {stats.avg}</p>
          </div>
        </div>

        {/* Month Selector */}
        <div className="flex flex-wrap gap-2 justify-center pb-2 overflow-x-auto no-scrollbar">
          {months.map(m => (
            <button
              key={m}
              onClick={() => setSelectedMonth(m)}
              className={`min-w-[45px] h-[45px] rounded-full text-sm font-medium transition-all ${
                selectedMonth === m 
                ? 'bg-[#D4A373] text-white shadow-md transform scale-110' 
                : 'bg-white text-[#A68A64] border border-[#E9E1D6] hover:bg-[#F2E8CF]'
              }`}
            >
              {m}月
            </button>
          ))}
        </div>

        {/* Input Form Card */}
        <div className="bg-white rounded-[2rem] p-6 shadow-sm border border-[#E9E1D6]">
          <h2 className="text-lg font-bold mb-6 flex items-center gap-2">
            <Plus size={20} className="text-[#D4A373]" /> 新增今日幸福
          </h2>
          
          <form onSubmit={handleAddRecord} className="space-y-6">
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div className="space-y-1">
                <label className="text-xs font-bold text-[#A68A64] ml-1">店家名稱</label>
                <input 
                  type="text" 
                  placeholder="哪家好喝？"
                  value={shopName}
                  onChange={(e) => setShopName(e.target.value)}
                  className="w-full bg-[#FDFBF7] border-none rounded-xl p-3 focus:ring-2 focus:ring-[#D4A373] outline-none text-sm"
                />
              </div>
              <div className="space-y-1">
                <label className="text-xs font-bold text-[#A68A64] ml-1">品項名稱</label>
                <input 
                  type="text" 
                  placeholder="點了什麼？"
                  value={itemName}
                  onChange={(e) => setItemName(e.target.value)}
                  className="w-full bg-[#FDFBF7] border-none rounded-xl p-3 focus:ring-2 focus:ring-[#D4A373] outline-none text-sm"
                />
              </div>
              <div className="space-y-1">
                <label className="text-xs font-bold text-[#A68A64] ml-1">金額</label>
                <input 
                  type="number" 
                  placeholder="NT$"
                  value={price}
                  onChange={(e) => setPrice(e.target.value)}
                  className="w-full bg-[#FDFBF7] border-none rounded-xl p-3 focus:ring-2 focus:ring-[#D4A373] outline-none text-sm font-bold"
                />
              </div>
            </div>

            {/* Selection Grids */}
            <div className="space-y-4">
              {/* Sweetness */}
              <div className="space-y-2">
                <p className="text-xs font-bold text-[#A68A64] ml-1">?? 甜度區</p>
                <div className="grid grid-cols-4 gap-2">
                  {sweetnessOptions.map(opt => (
                    <button
                      key={opt}
                      type="button"
                      onClick={() => setSweetness(opt)}
                      className={`py-2 rounded-xl text-xs transition-all border ${
                        sweetness === opt 
                        ? 'bg-[#D4A373] text-white border-[#D4A373] shadow-inner' 
                        : 'bg-white text-[#A68A64] border-[#E9E1D6]'
                      }`}
                    >
                      {opt}
                    </button>
                  ))}
                </div>
              </div>

              {/* Temperature */}
              <div className="space-y-2">
                <p className="text-xs font-bold text-[#A68A64] ml-1">?? 溫度區</p>
                <div className="grid grid-cols-4 gap-2">
                  {tempOptions.map(opt => (
                    <button
                      key={opt}
                      type="button"
                      onClick={() => setTemp(opt)}
                      className={`py-2 rounded-xl text-xs transition-all border ${
                        temp === opt 
                        ? 'bg-[#D4A373] text-white border-[#D4A373] shadow-inner' 
                        : 'bg-white text-[#A68A64] border-[#E9E1D6]'
                      }`}
                    >
                      {opt}
                    </button>
                  ))}
                </div>
              </div>

              {/* Toppings */}
              <div className="space-y-2">
                <p className="text-xs font-bold text-[#A68A64] ml-1">? 加料區</p>
                <div className="grid grid-cols-3 gap-2">
                  {toppingOptions.map(opt => (
                    <button
                      key={opt}
                      type="button"
                      onClick={() => setTopping(opt)}
                      className={`py-2 rounded-xl text-xs transition-all border ${
                        topping === opt 
                        ? 'bg-[#D4A373] text-white border-[#D4A373] shadow-inner' 
                        : 'bg-white text-[#A68A64] border-[#E9E1D6]'
                      }`}
                    >
                      {opt}
                    </button>
                  ))}
                </div>
              </div>
            </div>

            <button 
              type="submit"
              className="w-full bg-[#8B735B] text-[#FEFAE0] py-4 rounded-2xl font-bold text-lg hover:bg-[#6D5A47] transition-colors shadow-lg shadow-[#8B735B]/20"
            >
              幸福記錄
            </button>
          </form>
        </div>

        {/* History List */}
        <div className="space-y-4">
          <div className="flex justify-between items-center px-2">
            <h3 className="font-bold flex items-center gap-2">
              <Calendar size={18} className="text-[#D4A373]" /> {selectedMonth} 月紀錄清單
            </h3>
            <span className="text-xs font-medium text-[#A68A64]">
              本月共 {filteredRecords.length} 杯
            </span>
          </div>

          {filteredRecords.length === 0 ? (
            <div className="bg-white/40 border border-dashed border-[#E9E1D6] rounded-2xl p-8 text-center">
              <p className="text-[#A68A64] text-sm italic">本月還沒有紀錄喔，來一杯吧！??</p>
            </div>
          ) : (
            <div className="space-y-3">
              {filteredRecords.map(record => (
                <div 
                  key={record.id} 
                  className="bg-white p-4 rounded-2xl border border-[#E9E1D6] flex justify-between items-center group hover:shadow-md transition-all animate-in fade-in slide-in-from-bottom-2"
                >
                  <div className="space-y-1">
                    <p className="text-xs font-bold text-[#D4A373] uppercase">{record.shopName}</p>
                    <h4 className="font-bold text-[#5D4E46]">{record.itemName}</h4>
                    <div className="flex gap-2">
                      <span className="text-[10px] bg-[#F2E8CF] text-[#8B735B] px-2 py-0.5 rounded-full">{record.sweetness}</span>
                      <span className="text-[10px] bg-[#F2E8CF] text-[#8B735B] px-2 py-0.5 rounded-full">{record.temp}</span>
                      {record.topping !== '無' && (
                        <span className="text-[10px] bg-[#E9EDC9] text-[#8B735B] px-2 py-0.5 rounded-full">加{record.topping}</span>
                      )}
                    </div>
                  </div>
                  <div className="flex items-center gap-4">
                    <p className="text-xl font-bold text-[#8B735B] tracking-tight">$ {record.price}</p>
                    <button 
                      onClick={() => deleteRecord(record.id)}
                      className="p-2 text-[#E9E1D6] hover:text-red-400 transition-colors opacity-0 group-hover:opacity-100"
                    >
                      <Trash2 size={18} />
                    </button>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>

        <footer className="py-8 text-center text-[#A68A64] text-[10px] tracking-widest opacity-60">
          DESIGNED FOR HAPPINESS MOMENTS c 2026
        </footer>
      </div>
    </div>
  );
};

export default App;